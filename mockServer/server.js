const yaml = require('js-yaml')
const app=require('express')()
const {readFile}=require('fs-extra')
const bodyParser=require('body-parser')
app.use(bodyParser.json())

const loadYml=data=>new Promise((resolve, reject)=>{
    yaml.safeLoadAll(data, asJson=>{
        resolve(asJson)
    })
})
const getYML=()=>readFile(`${__dirname}/../serverless.yml`, 'utf8') 
const spline={"curve":[{"logStrike":-2.64268, "transformedOption":0.000870664},{"logStrike":-2.62198, "transformedOption":0.000887747},{"logStrike":-2.60127, "transformedOption":0.000905146},{"logStrike":-2.58057, "transformedOption":0.000922864},{"logStrike":-2.55987, "transformedOption":0.000940909},{"logStrike":-2.53916, "transformedOption":0.000959286},{"logStrike":-2.51846, "transformedOption":0.000977999},{"logStrike":-2.49776, "transformedOption":0.000997056},{"logStrike":-2.47705, "transformedOption":0.00101646},{"logStrike":-2.45635, "transformedOption":0.00103622},{"logStrike":-2.43565, "transformedOption":0.00105635},{"logStrike":-2.41494, "transformedOption":0.00107684},{"logStrike":-2.39424, "transformedOption":0.00109771},{"logStrike":-2.37354, "transformedOption":0.00111895},{"logStrike":-2.35283, "transformedOption":0.00114059},{"logStrike":-2.33213, "transformedOption":0.00116262},{"logStrike":-2.31143, "transformedOption":0.00118506},{"logStrike":-2.29072, "transformedOption":0.0012079},{"logStrike":-2.27002, "transformedOption":0.00123116},{"logStrike":-2.24932, "transformedOption":0.00125485},{"logStrike":-2.22861, "transformedOption":0.00127898},{"logStrike":-2.20791, "transformedOption":0.00130354},{"logStrike":-2.18721, "transformedOption":0.00132856},{"logStrike":-2.1665, "transformedOption":0.00135404},{"logStrike":-2.1458, "transformedOption":0.00137999},{"logStrike":-2.1251, "transformedOption":0.00140641},{"logStrike":-2.10439, "transformedOption":0.00143333},{"logStrike":-2.08369, "transformedOption":0.00146075},{"logStrike":-2.06299, "transformedOption":0.00148868},{"logStrike":-2.04228, "transformedOption":0.00151713},{"logStrike":-2.02158, "transformedOption":0.00154611},{"logStrike":-2.00088, "transformedOption":0.00157564},{"logStrike":-1.98017, "transformedOption":0.00160573},{"logStrike":-1.95947, "transformedOption":0.00163639},{"logStrike":-1.93877, "transformedOption":0.00166763},{"logStrike":-1.91806, "transformedOption":0.00169948},{"logStrike":-1.89736, "transformedOption":0.00173194},{"logStrike":-1.87666, "transformedOption":0.00176504},{"logStrike":-1.85595, "transformedOption":0.00179878},{"logStrike":-1.83525, "transformedOption":0.00183319},{"logStrike":-1.81455, "transformedOption":0.00186829},{"logStrike":-1.79384, "transformedOption":0.00190409},{"logStrike":-1.77314, "transformedOption":0.00194062},{"logStrike":-1.75244, "transformedOption":0.00197789},{"logStrike":-1.73173, "transformedOption":0.00201594},{"logStrike":-1.71103, "transformedOption":0.00205478},{"logStrike":-1.69033, "transformedOption":0.00209444},{"logStrike":-1.66962, "transformedOption":0.00213496},{"logStrike":-1.64892, "transformedOption":0.00217635},{"logStrike":-1.62822, "transformedOption":0.00221864},{"logStrike":-1.60751, "transformedOption":0.00226188},{"logStrike":-1.58681, "transformedOption":0.0023061},{"logStrike":-1.56611, "transformedOption":0.00235133},{"logStrike":-1.5454, "transformedOption":0.00239761},{"logStrike":-1.5247, "transformedOption":0.00244499},{"logStrike":-1.504, "transformedOption":0.0024935},{"logStrike":-1.48329, "transformedOption":0.0025432},{"logStrike":-1.46259, "transformedOption":0.00259414},{"logStrike":-1.44189, "transformedOption":0.00264637},{"logStrike":-1.42118, "transformedOption":0.00269995},{"logStrike":-1.40048, "transformedOption":0.00275493},{"logStrike":-1.37978, "transformedOption":0.00281139},{"logStrike":-1.35907, "transformedOption":0.00286939},{"logStrike":-1.33837, "transformedOption":0.00292901},{"logStrike":-1.31766, "transformedOption":0.00299033},{"logStrike":-1.29696, "transformedOption":0.00305343},{"logStrike":-1.27626, "transformedOption":0.0031184},{"logStrike":-1.25555, "transformedOption":0.00318535},{"logStrike":-1.23485, "transformedOption":0.00325436},{"logStrike":-1.21415, "transformedOption":0.00332556},{"logStrike":-1.19344, "transformedOption":0.00339906},{"logStrike":-1.17274, "transformedOption":0.00347499},{"logStrike":-1.15204, "transformedOption":0.00355348},{"logStrike":-1.13133, "transformedOption":0.00363469},{"logStrike":-1.11063, "transformedOption":0.00371875},{"logStrike":-1.08993, "transformedOption":0.00380584},{"logStrike":-1.06922, "transformedOption":0.00389614},{"logStrike":-1.04852, "transformedOption":0.00398983},{"logStrike":-1.02782, "transformedOption":0.00408712},{"logStrike":-1.00711, "transformedOption":0.00418822},{"logStrike":-0.986411, "transformedOption":0.00429336},{"logStrike":-0.965707, "transformedOption":0.0044028},{"logStrike":-0.945004, "transformedOption":0.0045168},{"logStrike":-0.924301, "transformedOption":0.00463563},{"logStrike":-0.903597, "transformedOption":0.00475962},{"logStrike":-0.882894, "transformedOption":0.00488907},{"logStrike":-0.86219, "transformedOption":0.00502434},{"logStrike":-0.841487, "transformedOption":0.00516581},{"logStrike":-0.820784, "transformedOption":0.00531385},{"logStrike":-0.80008, "transformedOption":0.00546892},{"logStrike":-0.779377, "transformedOption":0.00563145},{"logStrike":-0.758674, "transformedOption":0.00580193},{"logStrike":-0.73797, "transformedOption":0.00598089},{"logStrike":-0.717267, "transformedOption":0.00616888},{"logStrike":-0.696563, "transformedOption":0.0063665},{"logStrike":-0.67586, "transformedOption":0.00657439},{"logStrike":-0.655157, "transformedOption":0.00679322},{"logStrike":-0.634453, "transformedOption":0.00702373},{"logStrike":-0.61375, "transformedOption":0.0072672},{"logStrike":-0.593046, "transformedOption":0.00752665},{"logStrike":-0.572343, "transformedOption":0.00780568},{"logStrike":-0.55164, "transformedOption":0.00810831},{"logStrike":-0.530936, "transformedOption":0.00843895},{"logStrike":-0.510233, "transformedOption":0.00880251},{"logStrike":-0.48953, "transformedOption":0.00920437},{"logStrike":-0.468826, "transformedOption":0.00965048},{"logStrike":-0.448123, "transformedOption":0.0101474},{"logStrike":-0.427419, "transformedOption":0.0107021},{"logStrike":-0.406716, "transformedOption":0.0113227},{"logStrike":-0.386013, "transformedOption":0.0120176},{"logStrike":-0.365309, "transformedOption":0.0127963},{"logStrike":-0.344606, "transformedOption":0.013669},{"logStrike":-0.323902, "transformedOption":0.0146468},{"logStrike":-0.303199, "transformedOption":0.0159611},{"logStrike":-0.282496, "transformedOption":0.0180189},{"logStrike":-0.261792, "transformedOption":0.0207403},{"logStrike":-0.241089, "transformedOption":0.0240162},{"logStrike":-0.220386, "transformedOption":0.0277202},{"logStrike":-0.199682, "transformedOption":0.0317076},{"logStrike":-0.178979, "transformedOption":0.0358129},{"logStrike":-0.158275, "transformedOption":0.0402107},{"logStrike":-0.137572, "transformedOption":0.0453222},{"logStrike":-0.116869, "transformedOption":0.0510737},{"logStrike":-0.0961652, "transformedOption":0.0577024},{"logStrike":-0.0754618, "transformedOption":0.0652228},{"logStrike":-0.0547585, "transformedOption":0.0732777},{"logStrike":-0.0340551, "transformedOption":0.0817206},{"logStrike":-0.0133517, "transformedOption":0.0909892},{"logStrike":0.00735169, "transformedOption":0.094277},{"logStrike":0.0280551, "transformedOption":0.0849301},{"logStrike":0.0487585, "transformedOption":0.0759433},{"logStrike":0.0694618, "transformedOption":0.0676483},{"logStrike":0.0901652, "transformedOption":0.0599384},{"logStrike":0.110869, "transformedOption":0.0524205},{"logStrike":0.131572, "transformedOption":0.0461392},{"logStrike":0.152275, "transformedOption":0.0405842},{"logStrike":0.172979, "transformedOption":0.0353598},{"logStrike":0.193682,"transformedOption":0.0305464},{"logStrike":0.214386, "transformedOption":0.0262148},{"logStrike":0.235089, "transformedOption":0.0223911},{"logStrike":0.255792, "transformedOption":0.019075},{"logStrike":0.276496, "transformedOption":0.0162464},{"logStrike":0.297199, "transformedOption":0.0138549},{"logStrike":0.317902, "transformedOption":0.0116317},{"logStrike":0.338606, "transformedOption":0.010358},{"logStrike":0.359309, "transformedOption":0.00957709},{"logStrike":0.380013, "transformedOption":0.00884392},{"logStrike":0.400716, "transformedOption":0.0081565},{"logStrike":0.421419, "transformedOption":0.00751286},{"logStrike":0.442123, "transformedOption":0.00691106},{"logStrike":0.462826, "transformedOption":0.00634917},{"logStrike":0.48353, "transformedOption":0.00582529},{"logStrike":0.504233, "transformedOption":0.00533755},{"logStrike":0.524936, "transformedOption":0.00488412},{"logStrike":0.54564, "transformedOption":0.00446321},{"logStrike":0.566343, "transformedOption":0.00407304},{"logStrike":0.587046, "transformedOption":0.00371193},{"logStrike":0.60775, "transformedOption":0.0033782},{"logStrike":0.628453, "transformedOption":0.00307024},{"logStrike":0.649157, "transformedOption":0.0027865},{"logStrike":0.66986, "transformedOption":0.00252546},{"logStrike":0.690563, "transformedOption":0.00228568},{"logStrike":0.711267, "transformedOption":0.00206578},{"logStrike":0.73197, "transformedOption":0.00186441},{"logStrike":0.752674, "transformedOption":0.0016803},{"logStrike":0.773377, "transformedOption":0.00151224},{"logStrike":0.79408, "transformedOption":0.00135906},{"logStrike":0.814784, "transformedOption":0.00121968},{"logStrike":0.835487, "transformedOption":0.00109304},{"logStrike":0.85619, "transformedOption":0.000978172},{"logStrike":0.876894, "transformedOption":0.000874138},{"logStrike":0.897597, "transformedOption":0.00078007},{"logStrike":0.918301, "transformedOption":0.000695147},{"logStrike":0.939004, "transformedOption":0.000618602},{"logStrike":0.959707, "transformedOption":0.000549719},{"logStrike":0.980411, "transformedOption":0.000487829},{"logStrike":1.00111, "transformedOption":0.000432311},{"logStrike":1.02182, "transformedOption":0.000382586},{"logStrike":1.04252, "transformedOption":0.000338121},{"logStrike":1.06322, "transformedOption":0.000298421},{"logStrike":1.08393, "transformedOption":0.000263031},{"logStrike":1.10463, "transformedOption":0.000231533},{"logStrike":1.12533, "transformedOption":0.00020354},{"logStrike":1.14604, "transformedOption":0.000178702},{"logStrike":1.16674, "transformedOption":0.000156696},{"logStrike":1.18744, "transformedOption":0.000137228},{"logStrike":1.20815, "transformedOption":0.000120032},{"logStrike":1.22885, "transformedOption":0.000104864},{"logStrike":1.24955, "transformedOption":9.15047e-05},{"logStrike":1.27026, "transformedOption":7.97551e-05},{"logStrike":1.29096, "transformedOption":6.94359e-05},{"logStrike":1.31166, "transformedOption":6.03853e-05},{"logStrike":1.33237, "transformedOption":5.24583e-05},{"logStrike":1.35307, "transformedOption":4.55246e-05},{"logStrike":1.37378, "transformedOption":3.94677e-05},{"logStrike":1.39448, "transformedOption":3.41833e-05},{"logStrike":1.41518, "transformedOption":2.95788e-05},{"logStrike":1.43589, "transformedOption":2.55714e-05},{"logStrike":1.45659, "transformedOption":2.20878e-05},{"logStrike":1.47729, "transformedOption":1.90631e-05},{"logStrike":1.498, "transformedOption":1.64397e-05},{"logStrike":1.5187, "transformedOption":1.41667e-05},{"logStrike":1.5394, "transformedOption":1.21993e-05},{"logStrike":1.56011, "transformedOption":1.04982e-05},{"logStrike":1.58081, "transformedOption":9.02868e-06},{"logStrike":1.60151, "transformedOption":7.76033e-06},{"logStrike":1.62222, "transformedOption":6.66654e-06},{"logStrike":1.64292, "transformedOption":5.72406e-06},{"logStrike":1.66362, "transformedOption":4.91255e-06},{"logStrike":1.68433, "transformedOption":4.21432e-06},{"logStrike":1.70503, "transformedOption":3.61393e-06},{"logStrike":1.72573, "transformedOption":3.098e-06},{"logStrike":1.74644, "transformedOption":2.65489e-06},{"logStrike":1.76714, "transformedOption":2.27451e-06},{"logStrike":1.78784, "transformedOption":1.94813e-06},{"logStrike":1.80855, "transformedOption":1.6682e-06},{"logStrike":1.82925, "transformedOption":1.42818e-06},{"logStrike":1.84995, "transformedOption":1.22245e-06},{"logStrike":1.87066, "transformedOption":1.04615e-06},{"logStrike":1.89136, "transformedOption":8.95113e-07},{"logStrike":1.91206, "transformedOption":7.65726e-07},{"logStrike":1.93277, "transformedOption":6.54903e-07},{"logStrike":1.95347, "transformedOption":5.59985e-07},{"logStrike":1.97417, "transformedOption":4.78693e-07},{"logStrike":1.99488, "transformedOption":4.0907e-07},{"logStrike":2.01558, "transformedOption":3.49439e-07},{"logStrike":2.03628, "transformedOption":2.98362e-07},{"logStrike":2.05699, "transformedOption":2.54609e-07},{"logStrike":2.07769, "transformedOption":2.17127e-07},{"logStrike":2.09839, "transformedOption":1.85015e-07},{"logStrike":2.1191, "transformedOption":1.575e-07},{"logStrike":2.1398, "transformedOption":1.33925e-07},{"logStrike":2.1605, "transformedOption":1.13726e-07},{"logStrike":2.18121, "transformedOption":9.64195e-08},{"logStrike":2.20191, "transformedOption":8.15954e-08},{"logStrike":2.22261, "transformedOption":6.89011e-08},{"logStrike":2.24332, "transformedOption":5.80359e-08},{"logStrike":2.26402, "transformedOption":4.87425e-08},{"logStrike":2.28472, "transformedOption":4.0801e-08},{"logStrike":2.30543, "transformedOption":3.40231e-08},{"logStrike":2.32613, "transformedOption":2.82476e-08},{"logStrike":2.34683, "transformedOption":2.33363e-08},{"logStrike":2.36754, "transformedOption":1.91705e-08},{"logStrike":2.38824, "transformedOption":1.56484e-08},{"logStrike":2.40894, "transformedOption":1.26818e-08},{"logStrike":2.42965, "transformedOption":1.01949e-08},{"logStrike":2.45035, "transformedOption":8.12152e-09},{"logStrike":2.47105, "transformedOption":6.40439e-09},{"logStrike":2.49176, "transformedOption":4.99326e-09},{"logStrike":2.51246, "transformedOption":3.84403e-09},{"logStrike":2.53316, "transformedOption":2.91787e-09},{"logStrike":2.55387, "transformedOption":2.18041e-09},{"logStrike":2.57457, "transformedOption":1.60126e-09},{"logStrike":2.59527, "transformedOption":1.15352e-09},{"logStrike":2.61598, "transformedOption":8.13479e-10},{"logStrike":2.63668, "transformedOption":5.6035e-10}], "points":[{"logStrike":-0.633488, "transformedOption":0.00703478},{"logStrike":-0.31983, "transformedOption":0.0148525},{"logStrike":-0.176729, "transformedOption":0.0362584},{"logStrike":-0.112191, "transformedOption":0.0524528},{"logStrike":-0.081419, "transformedOption":0.0630155},{"logStrike":-0.051566, "transformedOption":0.0745308},{"logStrike":-0.0225785, "transformedOption":0.0866625},{"logStrike":0.0329913, "transformedOption":0.0827636},{"logStrike":0.0596596, "transformedOption":0.0714446},{"logStrike":0.0856351, "transformedOption":0.0616385},{"logStrike":0.110953, "transformedOption":0.0523927},{"logStrike":0.159743, "transformedOption":0.0386641},{"logStrike":0.293274, "transformedOption":0.0142889},{"logStrike":0.334096, "transformedOption":0.0105346}]}
const handlers={
    calculator:req=>{
        const {optionType, sensitivity, algorithm}=req.params
        return [{"value":-398.227,"atPoint":7.59411e+06},{"value":109.545,"atPoint":95},{"value":107.437,"atPoint":100},{"value":96.7123,"atPoint":130},{"value":91.1387,"atPoint":150},{"value":88.7082,"atPoint":160},{"value":87.5658,"atPoint":165},{"value":86.4664,"atPoint":170},{"value":85.4065,"atPoint":175},{"value":83.392,"atPoint":185},{"value":82.4319,"atPoint":190},{"value":81.4998,"atPoint":195},{"value":80.5938,"atPoint":200},{"value":78.8528,"atPoint":210},{"value":74.1016,"atPoint":240},{"value":72.6501,"atPoint":250},{"value":178.456,"atPoint":0.00419377}]
    },
    calibrator:req=>{
        const {calibration}=req.params
        return calibration==='spline'?spline:{"rho":-0.19246,"sigma":0.244064,"speed":2.7586,"v0":1.01803,"adaV":2.58261,"mse":8.69005e-05}
    },
    density:req=>{
        const {densityType}=req.params
        return densityType==='raw'?[{"value":-398.227,"atPoint":7.59411e+06},{"value":109.545,"atPoint":95},{"value":107.437,"atPoint":100},{"value":96.7123,"atPoint":130},{"value":91.1387,"atPoint":150},{"value":88.7082,"atPoint":160},{"value":87.5658,"atPoint":165},{"value":86.4664,"atPoint":170},{"value":85.4065,"atPoint":175},{"value":83.392,"atPoint":185},{"value":82.4319,"atPoint":190},{"value":81.4998,"atPoint":195},{"value":80.5938,"atPoint":200},{"value":78.8528,"atPoint":210},{"value":74.1016,"atPoint":240},{"value":72.6501,"atPoint":250},{"value":178.456,"atPoint":0.00419377}]:{ES:-2.0, VaR:-1.9}
    },
    defaultParameters:req=>{
        return {"T":{"upper":1e+06, "lower":0},"S0":{"upper":1e+06, "lower":0},"rho":{"upper":1, "lower":-1},"r":{"upper":0.4, "lower":0},"speed":{"upper":3, "lower":0},"v0":{"upper":1.8, "lower":0.2},"sigJ":{"upper":2, "lower":0},"adaV":{"upper":3, "lower":0},"sigma":{"upper":1, "lower":0},"muJ":{"upper":1, "lower":-1},"numU":{"upper":10, "lower":5},"lambda":{"upper":2, "lower":0}, "q":{"upper":20, "lower":0}, "delta":{"upper":2, "lower":0}}
    },
    getExpirationDates:req=>{
        return {S0:190.42, expirationDates:[1528416000000,
            1529020800000,
            1529625600000,
            1530230400000,
            1530835200000,
            1531440000000,
            1532044800000,
            1534464000000,
            1537488000000,
            1539907200000,
            1542326400000,
            1545350400000,
            1547769600000,
            1561075200000,
            1579219200000,
            1592524800000 ]}
    },
    getOptionPrices:req=>{
        return Object.assign({"S0":190.42000000000002,"T":2.0491793447171487,"r":0.004,"k":[85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,260,270,280,290,300],"prices":[105.475,101.275,95.025,91.475,86.75,82.75,77.75,73.75,68.975,65.75,62.25,57.75,53.75,50.125,46.8,43.3,40.425,36.8,34.7,31.125,29.3,26.975,24.375,22.25,20.075,18.425,16.6,14.825,12.75,11.8,11.024999999999999,9.55,8.675,7.199999999999999,6.325,4.25,3.42,3.4749999999999996,2.625]}, spline)
    }

}

const getYMLFunctions=doc=>Object.keys(doc.functions).forEach(key=>{
    const {handler, events}=doc.functions[key]
    const {method, path}=events[0].http
    const cleanedPath=path.replace('version', '').replace(/{/g, ':').replace(/}/g, '')
    app[method](cleanedPath, (req, res)=>{
        res.send(handlers[handler.split('.')[1]](req))
    })
})
const port=3001
getYML()
    .then(loadYml)
    .then(getYMLFunctions).then(()=>{
        app.listen(port, () => console.log(`Example app listening on port ${port}!`))
    })


